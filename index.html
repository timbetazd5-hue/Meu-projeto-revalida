<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plataforma Pós-Login</title>
<style>
  body { font-family:sans-serif; background:#0f172a; color:#e2e8f0;
         display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
  .card { background:#0b1220; padding:28px; border-radius:16px; width:360px;
          box-shadow:0 10px 30px rgba(0,0,0,0.5); text-align:center; }
  h1, h2 { margin-top:0; text-align:center; }
  input { width:100%; padding:10px; margin:6px 0; border-radius:8px; border:none; }
  button { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:none; background:#6366f1; color:#fff; cursor:pointer; }
  button:hover { background:#4f46e5; }
  .switch { color:#a5b4fc; cursor:pointer; text-decoration:underline; text-align:center; margin-top:8px; }
  .message { text-align:center; margin-top:8px; font-size:0.9rem; }
  .hidden { display:none; }
</style>
</head>
<body>

<div class="card">
  <!-- Login / Cadastro -->
  <div id="authContainer">
    <h1 id="formTitle">Login</h1>
    <form id="authForm">
      <input type="text" id="name" placeholder="Nome completo" class="extra hidden">
      <input type="number" id="age" placeholder="Idade" class="extra hidden">
      <input type="email" id="email" placeholder="E-mail" required>
      <input type="password" id="password" placeholder="Senha" required minlength="6">
      <button type="submit" id="submitBtn">Entrar</button>
    </form>
    <div class="switch" id="toggleForm">Não tem conta? Cadastre-se</div>
    <div class="message" id="message"></div>
  </div>

  <!-- Painel pós-login -->
  <div id="dashboard" class="hidden">
    <h2>Bem-vindo(a), <span id="userName"></span>!</h2>
    <p>Esta é sua área exclusiva.</p>
    <button id="logoutBtn">Sair</button>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const SUPABASE_URL = "https://hucepjpeuffnpjwiygwd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1Y2VwanBldWZmbnBqd2l5Z3dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDM0OTcsImV4cCI6MjA3MjYxOTQ5N30.oIB39VeHfYGcx6aeUjSiLKz9Q8RbJ9-of8RZ_S2tju0";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authForm = document.getElementById('authForm');
  const nameInput = document.getElementById('name');
  const ageInput = document.getElementById('age');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const submitBtn = document.getElementById('submitBtn');
  const toggleForm = document.getElementById('toggleForm');
  const formTitle = document.getElementById('formTitle');
  const messageDiv = document.getElementById('message');

  const authContainer = document.getElementById('authContainer');
  const dashboard = document.getElementById('dashboard');
  const userName = document.getElementById('userName');
  const logoutBtn = document.getElementById('logoutBtn');

  let isLogin = true;

  // Alternar entre login e cadastro
  toggleForm.addEventListener('click', () => {
    isLogin = !isLogin;
    formTitle.textContent = isLogin ? 'Login' : 'Cadastro';
    submitBtn.textContent = isLogin ? 'Entrar' : 'Cadastrar';
    toggleForm.textContent = isLogin ? 'Não tem conta? Cadastre-se' : 'Já tem conta? Faça login';
    document.querySelectorAll('.extra').forEach(el => el.classList.toggle('hidden', isLogin));
    messageDiv.textContent = '';
  });

  // Login / Cadastro
  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = emailInput.value;
    const password = passwordInput.value;
    messageDiv.textContent = "Aguarde...";

    try {
      if (isLogin) {
        const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email, password });
        if (loginError) throw loginError;
        showDashboard(loginData.user);
      } else {
        const name = nameInput.value;
        const age = parseInt(ageInput.value);

        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email, password });
        if (signUpError) throw signUpError;

        // Inserir dados extras na tabela profiles
        const userId = signUpData.user.id;
        const { error: insertError } = await supabase
          .from('profiles')
          .insert([{ id: userId, name, age }]);
        if (insertError) throw insertError;

        showDashboard({ email, name });
      }
    } catch (err) {
      messageDiv.textContent = "Erro: " + err.message;
    }
  });

  // Mostrar painel
  async function showDashboard(user) {
    authContainer.classList.add('hidden');
    dashboard.classList.remove('hidden');
    userName.textContent = user.name || user.email;
    messageDiv.textContent = '';
  }

  // Logout
  logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    dashboard.classList.add('hidden');
    authContainer.classList.remove('hidden');
    authForm.reset();
  });

  // Checar sessão ao abrir página
  async function checkSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      const { data: profileData } = await supabase
        .from('profiles')
        .select('name')
        .eq('id', session.user.id)
        .single();
      showDashboard({ email: session.user.email, name: profileData?.name });
    }
  }
  checkSession();
</script>
</body>
</html>
